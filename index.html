<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer Cube Chat</title>
<style>
  body { margin: 0; overflow: hidden; background: white; font-family: sans-serif; }
  canvas { display: block; }
  #chatBox {
    position: fixed; top: 10px; left: 10px;
    width: 300px; height: 200px;
    overflow: hidden; display: flex;
    flex-direction: column-reverse;
    font-size: 14px;
  }
  .message {
    background: rgba(0,0,0,0.1);
    margin-top: 2px;
    padding: 2px 5px;
    border-radius: 3px;
  }
  #chatInput {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 250px;
    padding: 5px;
    font-size: 16px;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="chatBox"></div>
<input id="chatInput" type="text" placeholder="Type message..." maxlength="100">

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

let playerId = null;
let players = {};
const speed = 5;
const playerSize = 40;
let keys = {};

document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");

chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && chatInput.value.trim()) {
    socket.emit("chat", chatInput.value.trim());
    chatInput.value = "";
  }
});

function addChatMessage(text) {
  const msg = document.createElement("div");
  msg.className = "message";
  msg.textContent = text;
  chatBox.prepend(msg);
  setTimeout(() => msg.remove(), 10000);
}

// Socket.IO events
socket.on("connect", () => {
  playerId = socket.id;
});

socket.on("init", (data) => {
  players = data;
});

socket.on("newPlayer", ({ id, data }) => {
  players[id] = data;
});

socket.on("update", ({ id, x, y }) => {
  if (players[id]) {
    players[id].x = x;
    players[id].y = y;
  }
});

socket.on("removePlayer", (id) => {
  delete players[id];
});

socket.on("chat", ({ id, text }) => {
  addChatMessage(`${id === playerId ? "You" : id}: ${text}`);
});

function update() {
  let p = players[playerId];
  if (!p) return;
  if (keys["w"]) p.y -= speed;
  if (keys["s"]) p.y += speed;
  if (keys["a"]) p.x -= speed;
  if (keys["d"]) p.x += speed;
  socket.emit("move", { x: p.x, y: p.y });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let id in players) {
    let p = players[id];
    ctx.fillStyle = id === playerId ? "black" : "gray";
    ctx.fillRect(p.x, p.y, playerSize, playerSize);
  }
}

function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
